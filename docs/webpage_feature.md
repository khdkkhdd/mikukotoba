# 일반 웹페이지 번역 기능 명세서

> JP Helper - YouTube·Twitter(X) 이외의 일반 웹사이트에 대한 번역 기능의 사용자 관점 기능 명세
> 작성일: 2026-02-19

---

## 1. 기능 개요

YouTube·Twitter(X) 이외의 **모든 웹사이트**에서 일본어 텍스트를 감지하여 한국어로 번역하고, 후리가나·로마자를 함께 표시하여 학습을 돕는 기능.

**핵심 가치**: "일본어가 있는 어떤 사이트든 → 자동으로 감지하고 → 읽기 보조와 번역을 제공한다"의 범용 학습 지원

**이 문서의 범위**: YouTube·Twitter(X) 전용 핸들러가 동작하지 않는 모든 사이트에서의 번역 동작을 다룬다. 번역 엔진 선택, 호버/인라인/후리가나 표시 방식의 공통 동작, 설정 페이지 등은 `translation_feature.md`를 참고한다.

**적용 범위**: `youtube.com`, `twitter.com`, `x.com`을 **제외한** 모든 웹사이트

---

## 2. 활성화 조건

### 2.1 지연 활성화

YouTube·Twitter와 달리, 일반 웹페이지 핸들러는 **즉시 시작하지 않는다**. 페이지에 일본어 콘텐츠가 있는지 먼저 확인한 뒤에만 활성화된다.

1. 페이지 로드 시, 본문 텍스트 앞부분(약 5,000자)의 일본어 비율을 검사한다.
2. 일본어 비율이 10%를 넘으면 즉시 활성화된다.
3. 넘지 않으면 경량 감시 모드로 대기하다가, 이후 동적으로 일본어 텍스트가 추가되는 시점에 활성화된다.

이 방식 덕분에 일본어가 전혀 없는 한국어/영어 사이트에서는 번역 엔진이 로드되지 않아 리소스를 절약한다.

### 2.2 비활성화 조건

- 팝업에서 **웹페이지 모드**가 OFF로 설정된 경우
- 확장 프로그램 전체가 비활성화(OFF)된 경우
- YouTube, Twitter(X) 도메인인 경우 (전용 핸들러가 대신 동작)

---

## 3. 번역 대상

### 3.1 대상이 되는 요소

페이지 내의 모든 **블록 레벨 요소**에 포함된 일본어 텍스트가 번역 대상이다. 사이트별 전용 셀렉터 없이, 범용적인 DOM 탐색으로 텍스트를 찾는다.

| 요소 예시 | 설명 |
|----------|------|
| **문단(p)** | 본문 텍스트 |
| **제목(h1~h6)** | 페이지·섹션 제목 |
| **리스트(li)** | 목록 항목 |
| **테이블 셀(td, th)** | 표 내용 |
| **div, section** | 블록 단위 컨테이너 |
| **article** | 글 본문 |
| **blockquote** | 인용문 |
| **figcaption** | 이미지 캡션 |

블록 레벨 요소란 CSS `display`가 `block`, `flex`, `grid`, `list-item`, `table-cell` 중 하나인 요소를 말한다.

### 3.2 텍스트 노드 그룹핑

하나의 블록 레벨 요소 안에 있는 여러 텍스트 노드는 하나의 번역 단위로 묶인다. 예를 들어, `<p>` 안에 `<span>`과 `<a>`로 나뉜 텍스트가 있어도 하나의 문장으로 취급하여 번역한다.

---

## 4. 번역 제외 대상

다음은 번역하지 않는다:

| 항목 | 설명 |
|------|------|
| **스크립트/스타일** | `<script>`, `<style>` 태그 내부 |
| **입력 필드** | `<input>`, `<textarea>`, `contenteditable` 영역, `role="textbox"`, `role="combobox"` |
| **JP Helper 삽입 요소** | 이미 번역이 삽입된 요소 (`data-jp-translation`, `data-jp-processed` 속성) |
| **일본어 비율 낮은 텍스트** | 히라가나·카타카나가 없거나, 일본어 문자 비율이 10% 미만인 텍스트 |
| **이미 번역된 텍스트** | 동일한 요소를 중복 번역하지 않음 (텍스트가 변경된 경우에만 재번역) |

---

## 5. 일본어 감지

### 5.1 판별 기준

텍스트에 **히라가나** 또는 **카타카나**가 포함되어 있어야 일본어로 인식한다. 한자만 있는 텍스트는 중국어일 수 있으므로 일반적으로 번역 대상에서 제외된다.

### 5.2 일본어 비율 검사

텍스트 전체에서 히라가나·카타카나·한자가 차지하는 비율이 10%를 넘어야 번역 대상이 된다. 일본어 단어가 한두 개 섞인 한국어·영어 텍스트는 번역하지 않는다.

---

## 6. 표시 방식

웹페이지 모드(호버/인라인/후리가나 전용) 설정에 따라 동작이 달라진다.

### 6.1 호버 모드

일본어 텍스트 위에 **마우스를 올리면** 번역 팝업이 나타난다.

#### 동작 흐름

1. 마우스가 일본어 텍스트 블록 위에 **1초간** 머물면 팝업이 나타난다.
2. 팝업에 로딩 상태("번역 중...")가 먼저 표시된다.
3. 번역이 완료되면 결과로 교체된다.

#### 팝업 내용

| 요소 | 조건 |
|------|------|
| **로마자** | 로마자 ON일 때 |
| **한국어 번역** | 항상 |
| **엔진 표시** | 항상 (예: `papago`, `claude cache`) |
| **재번역 버튼 (↻)** | 항상 |

#### 팝업 동작

- **위치**: 마우스 커서 근처. 화면 밖으로 넘어가면 자동으로 위치 조정.
- **유지**: 마우스가 원래 텍스트 또는 팝업 위에 있는 동안 유지.
- **닫기**: 마우스를 벗어나면 0.1초 후 사라짐. ESC 키로 즉시 닫기.
- **텍스트 선택**: 팝업 안의 번역문을 드래그로 선택·복사 가능. 선택 중에는 팝업이 사라지지 않음.
- **스크롤 격리**: 팝업 안에서 스크롤해도 뒤쪽 페이지가 같이 스크롤되지 않음.
- **텍스트 길이 제한**: 500자를 초과하는 블록은 호버 대상에서 제외됨 (너무 큰 컨테이너를 잡는 것을 방지).

### 6.2 인라인 모드

일본어 텍스트를 감지하면, 원문에 후리가나를 붙이고 그 아래에 번역 블록을 자동 삽입한다.

#### 원문 변환 (후리가나 ON일 때)

원문 텍스트 노드가 후리가나가 붙은 버전으로 대체된다. 한자 위에 히라가나 읽기가 루비(ruby) 형태로 표시되며, 줄 높이가 넓어져 후리가나가 겹치지 않는다.

#### 번역 블록 구성 (위에서 아래로)

| 줄 | 내용 | 조건 |
|----|------|------|
| **1줄** | 로마자 | 로마자 ON일 때 |
| **2줄** | 한국어 번역 | 번역 ON일 때 |
| **3줄** | 엔진 배지 + 재번역 버튼 | 항상 |

- 번역 블록은 원문 요소 바로 아래에 삽입되며, 얇은 구분선으로 원문과 구분된다.
- 번역문은 이탤릭체로 표시되어 원문과 시각적으로 구별된다.
- **재번역 (↻)**: 버튼 클릭 시 AI 엔진으로 다시 번역. 버튼이 회전 애니메이션으로 바뀌며, 완료 시 새 결과로 교체.

#### 번역 실패 시

번역이 실패하면 해당 블록을 "미처리" 상태로 되돌려, 다음 감지 사이클에서 재시도할 수 있게 한다.

### 6.3 후리가나 전용 모드

번역 없이, 한자 위에 **후리가나(읽기 보조)만** 표시하는 모드.

- 원문의 각 한자에 히라가나 읽기가 루비(ruby) 형태로 추가된다.
- 번역 블록·로마자는 표시하지 않는다.
- **번역 API를 호출하지 않는다** — 형태소 분석(Kuromoji)만 사용하므로 API 비용이 발생하지 않는다.
- 한자가 없는 텍스트(히라가나·카타카나만)는 건너뛴다.

---

## 7. 동적 콘텐츠 대응

### 7.1 새 요소 감지

SPA(Single Page Application)나 무한 스크롤 페이지에서 새로 추가되는 요소를 자동 감지하여 번역한다.

- 페이지에 새 HTML 요소가 추가되면 자동으로 탐색하여 일본어 블록을 찾는다.
- JP Helper가 삽입한 번역 요소는 자동으로 무시하여 무한 루프를 방지한다.

### 7.2 텍스트 변경 감지

이미 번역된 요소의 텍스트가 변경되면 이를 감지한다.

- 이전에 처리한 텍스트와 현재 텍스트를 비교하여, 다른 경우에만 재번역한다.
- "더 보기" 버튼 등으로 텍스트가 펼쳐지는 경우를 자동으로 포착한다.

### 7.3 뷰포트 기반 감지

화면에 보이는 영역 근처의 요소만 번역한다.

- 화면에 보이기 **200px 전**부터 미리 번역을 시작한다.
- 화면에서 멀리 떨어진 요소는 번역하지 않아 불필요한 API 호출을 방지한다.
- 스크롤하여 해당 요소가 화면 근처에 도달하면 번역이 시작된다.

### 7.4 성능 최적화

번역 작업이 페이지 반응성을 해치지 않도록 최적화되어 있다.

- **일괄 처리**: 감지된 블록을 한꺼번에 처리하지 않고, 5개(인라인 모드) 또는 100개 노드(후리가나 모드) 단위로 나누어 처리한다.
- **유휴 시간 활용**: 각 묶음 사이에 브라우저가 다른 작업(스크롤, 클릭 등)을 처리할 시간을 확보한다.
- **중복 방지**: 이미 처리한 요소는 다시 처리하지 않으며, 요소가 DOM에서 제거되면 추적 정보도 자동으로 정리된다.
- **동시 번역 제한**: API 호출이 한꺼번에 몰리지 않도록 동시 번역 수가 제한된다(최대 3건).

---

## 8. 상태 표시기

화면 우하단에 작은 **알약 모양 배지**가 표시되어 번역 진행 상황을 알려준다.

| 상태 | 색상 | 표시 내용 | 예시 |
|------|------|----------|------|
| **대기** | 회색 | JP Helper | — |
| **감지 중** | 노랑 (깜빡임) | 일본어 감지 (N) | `일본어 감지 (12)` |
| **번역 중** | 파랑 (깜빡임) | 번역 중 (완료/전체) | `번역 중 (3/12)` |
| **완료** | 초록 | 번역 완료 (N) | `번역 완료 (12)` |
| **오류** | 빨강 | 번역 오류 (완료/전체, N fail) | `번역 오류 (10/12, 2 fail)` |

- 번역이 완료되면 4초 후 자동으로 사라진다.
- 클릭하면 즉시 숨길 수 있다.
- 페이지 CSS의 영향을 받지 않도록 격리되어 있다.

---

## 9. 설정 변경 시 동작

### 9.1 실시간 반영

팝업이나 설정 페이지에서 설정을 변경하면 현재 열린 모든 탭에 즉시 반영된다.

- **모드 변경** (호버 ↔ 인라인 ↔ 후리가나 전용 ↔ OFF): 기존 번역이 모두 제거되고, 새 모드로 처음부터 다시 시작된다.
- **표시 옵션 변경** (후리가나/로마자/번역 토글): 마찬가지로 모든 번역이 재적용된다.
- **색상/크기 변경**: CSS 변수가 즉시 업데이트되어 기존 번역 요소에도 반영된다.
- **확장 ON/OFF**: 모든 번역 요소가 즉시 제거되거나 복원된다.

### 9.2 모드 전환 시 정리

모드를 변경하면 이전 모드의 삽입 요소가 깨끗이 제거된다:
- 인라인 모드의 번역 블록 제거
- 후리가나 전용 모드의 루비 주석 원복 (원래 텍스트 노드로 복원)
- 호버 모드의 팝업 및 이벤트 리스너 제거

---

## 10. 호버 모드의 사이트별 차이

호버 팝업은 YouTube 페이지 번역, Twitter, 일반 웹페이지에서 모두 사용되지만 반응 속도가 다르다:

| 사이트 | 호버 지연 시간 | 이유 |
|--------|-------------|------|
| **Twitter** | 0.3초 | 타임라인을 빠르게 훑으면서 특정 트윗에 관심을 가질 때 빠른 반응이 필요 |
| **일반 웹페이지** | 1초 | 긴 글을 읽을 때 의도하지 않은 팝업이 뜨는 것을 방지 |

---

## 11. 제한사항

| 항목 | 설명 |
|------|------|
| 일본어만 번역 | 다른 언어의 텍스트는 번역 대상이 아님 |
| 한자만 있는 텍스트 미지원 | 히라가나·카타카나 없이 한자만 있으면 일본어로 인식하지 않음 (중국어 구별 불가) |
| 블록 레벨 요소 단위 | 인라인 요소(`<span>`, `<a>` 등) 단독으로는 번역 대상이 되지 않음. 부모 블록 요소를 찾아 그 단위로 번역 |
| 긴 텍스트 호버 제한 | 호버 모드에서 500자를 초과하는 블록은 호버 번역 대상에서 제외됨 |
| 사이트별 최적화 없음 | YouTube·Twitter처럼 사이트 구조에 맞춘 셀렉터가 없어, 일부 사이트에서 번역 대상 선별이 부정확할 수 있음 |
| 인라인 모드 레이아웃 간섭 | 번역 블록 삽입이 원래 페이지의 레이아웃(그리드, 카드 등)을 깨뜨릴 수 있음 |
| 후리가나 줄 높이 변경 | 후리가나를 위해 줄 높이가 2.3em으로 변경되어, 원래 레이아웃과 다르게 보일 수 있음 |
| 편집 영역 미지원 | `contenteditable`, `role="textbox"` 등 사용자 입력 영역은 번역하지 않음 |
| 스포일러(블러) 미적용 | YouTube·Twitter의 인라인 모드와 달리 한국어 번역이 바로 보임 (블러 처리되지 않음) |
| 이미지 내 텍스트 미지원 | 이미지에 포함된 일본어 텍스트는 번역 불가 (OCR 미탑재) |
| PDF 미지원 | 브라우저에서 열린 PDF 문서 내의 텍스트는 번역되지 않음 |
| iframe 미지원 | iframe 내부의 콘텐츠는 번역 대상이 아님 |
| Shadow DOM 미지원 | Shadow DOM으로 격리된 컴포넌트 내부는 번역되지 않음 |

---

## 12. To-Do: 학습 효과 개선을 위한 추가 기능 제안

### 높은 우선순위

| 기능 | 설명 | 근거 |
|------|------|------|
| **인라인 모드 스포일러 처리** | YouTube·Twitter처럼 인라인 모드의 한국어 번역을 블러 처리하여 "먼저 스스로 해석해보기" 학습 흐름 지원 | 현재 일반 웹페이지에서만 스포일러가 적용되지 않아, 학습 흐름이 사이트마다 일관되지 않음 |
| **단어 클릭 → 단어장 추가** | 인라인 모드의 후리가나가 붙은 텍스트에서 개별 단어를 클릭하면 단어장에 추가. 예문에는 해당 문장이 자동 입력 | 읽기 중 발견한 단어를 즉시 저장하여 학습 사이클 완성 |
| **사이트별 핸들러 확장** | 자주 사용되는 일본어 사이트(뉴스, 블로그, 위키 등)에 대해 전용 핸들러 추가 | 범용 핸들러보다 정확한 요소 선별과 더 나은 레이아웃 통합 가능 |
| **인라인 모드 레이아웃 안정화** | 그리드·카드 레이아웃 등에서 번역 블록이 레이아웃을 깨뜨리지 않도록 개선 | 뉴스 사이트, 블로그 등에서 실사용 시 빈번하게 발생하는 문제 |

### 중간 우선순위

| 기능 | 설명 | 근거 |
|------|------|------|
| **호버 모드 텍스트 길이 제한 완화** | 500자 이상의 블록도 부분적으로 번역하거나, 마우스 위치 근처의 문장만 번역하는 방식 | 긴 문단에서도 호버 번역을 사용할 수 있도록 |
| **호버 모드에서 후리가나 표시** | 호버 팝업에 후리가나가 붙은 원문도 함께 표시 | 현재 팝업에는 로마자·번역만 표시되며, 후리가나를 보려면 인라인/후리가나 모드를 써야 함 |
| **번역 난이도 표시** | 각 블록의 JLPT 추정 레벨을 배지로 표시 (색상: N5=초록 ~ N1=빨강) | 자신의 수준에 맞는 글을 찾거나, 학습 진도를 파악 |
| **선택 영역 번역** | 텍스트를 드래그 선택한 뒤 단축키로 해당 부분만 번역 | 전체 번역 대신 특정 문장만 빠르게 번역하고 싶을 때 |
| **다크/라이트 모드 대응** | 사이트의 테마에 맞춰 번역 블록·구분선의 색상을 자동 조정 | YouTube 핸들러는 지원하지만, 일반 웹페이지에서는 밝은 테마·어두운 테마 판별이 안 됨 |
| **PDF 번역** | 브라우저에서 열린 PDF 내의 텍스트 레이어를 감지하여 번역 | 일본어 학습 자료가 PDF 형태인 경우가 많음 |

### 낮은 우선순위

| 기능 | 설명 | 근거 |
|------|------|------|
| **iframe 내 콘텐츠 번역** | iframe으로 삽입된 콘텐츠도 번역 대상에 포함 | 일부 사이트에서 콘텐츠가 iframe으로 격리되어 번역되지 않는 문제 해결 |
| **Shadow DOM 대응** | Web Components의 Shadow DOM 내부 텍스트도 감지·번역 | 최신 웹 프레임워크를 사용하는 사이트에서의 호환성 향상 |
| **번역 영역 수동 지정** | 사용자가 직접 번역할 영역을 마우스로 지정하는 모드 | 자동 감지가 부정확한 사이트에서 수동 제어 가능 |
| **페이지별 설정 기억** | 특정 사이트에서의 모드 설정을 기억하여 다음 방문 시 자동 적용 | 예: 뉴스 사이트에서는 인라인, 포럼에서는 호버 등 |
| **읽기 모드 통합** | 브라우저의 읽기 모드(Reader View)와 연동하여 정리된 레이아웃에서 번역 표시 | 레이아웃 간섭 없이 깨끗한 학습 환경 제공 |
| **오프라인 후리가나** | 후리가나 전용 모드를 인터넷 없이 사용 가능하도록 (이미 로컬 형태소 분석 사용) | 비행기 등 오프라인 환경에서의 읽기 보조 |
| **번역 이력 저장** | 방문한 사이트별로 번역한 문장을 자동 기록하여 나중에 복습 | 어떤 사이트에서 어떤 표현을 만났는지 돌아보기 |
